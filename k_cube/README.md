# K-Cube (kv): 一个为知识管理而生的版本控制工具

K-Cube 是一个本地优先、对开发者友好的个人知识管理系统。它通过一个定制化的命令行工具 `kv`，提供了强大而直观的版本控制能力，帮助你安全、清晰地记录知识的每一次演进。

## 核心特性

- **本地优先**: 所有数据都存储在你的本地文件系统，你拥有100%的数据主权。
- **结构化版本信息**: 每次保存都不仅仅是一行消息，而是包含类型、摘要、关联链接的结构化数据。
- **优秀的可视化**: 无论是状态报告还是历史日志，都经过精心设计，信息清晰、美观。
- **开发者友好**: 底层为纯文本Markdown，可与VSCode、Obsidian等任何文本编辑器无缝协作。
- **安全可靠**: 内置安全检查和备份机制，防止误操作导致数据丢失。

## 安装

1.  确保你已安装 Python 3.9+ 和 pip。
2.  克隆本仓库到本地。
3.  在仓库根目录下，运行以下命令进行安装：

    ```bash
    pip install -e .
    ```

    这会安装 `kv` 命令到你的系统中。

## 快速入门

1.  **初始化仓库**:
    进入你想要作为知识库根目录的文件夹，运行：
    ```bash
    kv init
    ```
    这会创建一个 `.kcube` 目录来存储所有版本信息。

2.  **查看状态**:
    创建或修改一些 `.md` 文件后，随时查看当前状态：
    ```bash
    kv status
    ```
    它会清晰地列出哪些文件是“未追踪的”、“未暂存的”和“已暂存的”。

3.  **暂存变更**:
    使用 `add` 命令将你的变更加入到“暂存区”，准备下一次提交。
    ```bash
    # 暂存单个文件
    kv add my_note.md

    # 暂存整个目录
    kv add my_project_notes/

    # 暂存被删除的文件
    rm old_note.md
    kv add old_note.md
    ```

4.  **提交变更**:
    使用 `commit` 命令将暂存区的所有内容固化为一个历史版本。
    ```bash
    kv commit
    ```
    系统会交互式地引导你输入本次提交的**类型**、**摘要**和**关联链接**。
    你也可以使用 `-m` 选项快速添加摘要：
    ```bash
    kv commit -m "补充了伙伴系统的内存分配细节"
    ```

## 命令详解

### `kv init`
在当前目录初始化一个新的 K-Cube 保险库。

### `kv status`
显示工作区相对于暂存区和最新提交的变更状态。输出分为三个部分：
- **待提交的变更**: 已使用 `kv add` 暂存，将包含在下一次 `kv commit` 中。
- **未暂存的变更**: 已修改或已删除，但未使用 `kv add` 暂存。
- **未追踪的文件**: 新创建的文件，从未被追踪过。

### `kv add <路径...>`
将一个或多个文件/目录的变更添加到暂存区。
- 对于新文件和修改过的文件，会将其当前内容加入暂存。
- 对于被删除的文件，会将其“删除”状态加入暂存。

### `kv commit`
将暂存区的所有变更创建一个新的版本快照。
- **选项**:
  - `-m, --message <摘要>`: 直接提供提交摘要，跳过交互式提问。

### `kv log [文件路径]`
以卡片式时间线的形式显示版本历史。
- 如果不提供文件路径，显示整个仓库的提交历史。
- 如果提供文件路径，只显示与该文件相关的提交历史。

### `kv restore <版本> [文件路径]`
恢复文件或整个工作区到指定的历史版本。
- **恢复单个文件**:
  ```bash
  kv restore a1b2c3d my_note.md
  ```
  这会将 `my_note.md` 的内容恢复到 `a1b2c3d` 版本。当前文件会被备份为 `.bak` 文件。

- **恢复整个工作区 (软模式)**:
  ```bash
  kv restore a1b2c3d
  ```
  这会将所有被追踪的文件恢复到指定版本，但**不会**删除你在本地新增的“未追踪文件”。

- **恢复整个工作区 (硬模式)**:
  ```bash
  kv restore a1b2c3d --hard
  ```
  除了恢复文件，还会**删除**所有当前工作区存在、但在 `a1b2c3d` 版本中不存在的文件。**这是一个危险操作，请谨慎使用！**

### `kv reset [文件路径...]`
从暂存区撤销 `kv add` 的操作。
- **撤销部分暂存**:
  ```bash
  kv reset my_note.md
  ```
  这会将 `my_note.md` 的变更从暂存区移回到“未暂存的变更”区域。

- **清空暂存区**:
  ```bash
  kv reset
  ```
  这会撤销所有已 `add` 但未 `commit` 的变更。

### `kv revert <版本>`
通过创建一个**新的提交**来撤销某个历史提交的全部更改。
- 这个操作是安全的，因为它**不会修改历史**，而是在历史的顶端添加一个“反向操作”的提交。
- 适用于撤销已经提交的错误。
  ```bash
  kv revert a1b2c3d
  ```